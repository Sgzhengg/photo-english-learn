# PhotoEnglish - Zeabur Deployment Configuration
# 前后端一体化部署配置

services:
  # ============================================
  # 前端 - 静态网站托管
  # ============================================
  - name: frontend
    type: Static
    description: "Frontend - React + Vite"
    buildCommand: |
      npm install
      npm run build
    outputPath: dist
    rootDir: frontend
    env:
      - VITE_API_BASE_URL=https://photo-english-learn-api-gateway.zeabur.app
    deployments:
      - domain:
          - name: main
            value: photo-english-learn

  # ============================================
  # API Gateway
  # ============================================
  - name: api-gateway
    type: Worker
    description: "API Gateway"
    env:
      - PORT=8080
      - AUTH_SERVICE_URL=http://auth-service.zeabur.internal:8001
      - VISION_SERVICE_URL=http://vision-service.zeabur.internal:8003
      - WORD_SERVICE_URL=http://word-service.zeabur.internal:8004
      - PRACTICE_SERVICE_URL=http://practice-service.zeabur.internal:8005
      - TTS_SERVICE_URL=http://tts-service.zeabur.internal:8006
      - ASR_SERVICE_URL=http://asr-service.zeabur.internal:8080
      - SKIP_AUTH=true
      - GROQ_API_KEY=${GROQ_API_KEY}
    buildCommand: |
      pip install -r requirements.txt
    runCommand: uvicorn services.api-gateway.main:app --host 0.0.0.0 --port $PORT
    ports:
      - port: 8080
        public: true
    deployments:
      - domain:
          - name: main
            value: photo-english-learn-api-gateway

  # ============================================
  # 后端微服务
  # ============================================
  - name: auth-service
    type: Worker
    description: "Authentication Service"
    buildCommand: |
      pip install -r requirements.txt
    runCommand: uvicorn services.auth_service.main:app --host 0.0.0.0 --port 8001
    ports:
      - port: 8001
        public: false

  - name: vision-service
    type: Worker
    description: "Vision/AI Service"
    buildCommand: |
      pip install -r requirements.txt
    runCommand: uvicorn services.vision-service.main:app --host 0.0.0.0 --port 8003
    ports:
      - port: 8003
        public: false
    env:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}

  - name: word-service
    type: Worker
    description: "Word/Vocabulary Service"
    buildCommand: |
      pip install -r requirements.txt
    runCommand: uvicorn services.word-service.main:app --host 0.0.0.0 --port 8004
    ports:
      - port: 8004
        public: false

  - name: practice-service
    type: Worker
    description: "Practice/Review Service"
    buildCommand: |
      pip install -r requirements.txt
    runCommand: uvicorn services.practice-service.main:app --host 0.0.0.0 --port 8005
    ports:
      - port: 8005
        public: false

  - name: tts-service
    type: Worker
    description: "Text-to-Speech Service"
    buildCommand: |
      pip install -r requirements.txt
    runCommand: uvicorn services.tts-service.main:app --host 0.0.0.0 --port 8006
    ports:
      - port: 8006
        public: false

  - name: asr-service
    type: Worker
    description: "ASR/Speech Recognition Service"
    buildCommand: |
      pip install -r requirements.txt
    runCommand: uvicorn services.asr-service.main:app --host 0.0.0.0 --port 8080
    ports:
      - port: 8080
        public: false
    env:
      - GROQ_API_KEY=${GROQ_API_KEY}

# ============================================
# 全局环境变量
# ============================================
env:
  - SKIP_AUTH=true
  - DATABASE_URL=${DATABASE_URL}
  - REDIS_URL=${REDIS_URL}
  - GROQ_API_KEY=${GROQ_API_KEY}
